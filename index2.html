<!doctype html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CV - Hu·ª≥nh Th·ªã Kim H√¢n</title>
    <link rel="stylesheet" href="styles.css" />
  </head>

  <body>
    <main class="page">
      <div class="cv" id="cvRoot">
        <!-- HEADER -->
        <header class="header">
          <div class="avatar-wrap">
            <img
              id="avatarImg"
              class="avatar"
              src="avatar.jpg"
              alt="·∫¢nh ƒë·∫°i di·ªán"
            />
          </div>

          <div class="header-info">
            <h1 id="cvName" class="name">Hu·ª≥nh Th·ªã Kim H√¢n</h1>
            <p id="cvHeadline" class="headline">
              ·ª®ng tuy·ªÉn v·ªã tr√≠ nh√¢n vi√™n Telesale, Nh√¢n vi√™n vƒÉn ph√≤ng
            </p>
            <ul id="cvMeta" class="meta"></ul>
          </div>
        </header>

        <!-- H·ªåC V·∫§N -->
        <section class="section">
          <div class="section-head">
            <h2 class="section-title">H·ªåC V·∫§N</h2>
            <div class="section-line"></div>
          </div>
          <div id="eduRows" class="rows"></div>
        </section>

        <!-- KINH NGHI·ªÜM -->
        <section class="section">
          <div class="section-head">
            <h2 class="section-title">KINH NGHI·ªÜM L√ÄM VI·ªÜC</h2>
            <div class="section-line"></div>
          </div>
          <div id="expRows" class="rows"></div>
        </section>

        <!-- CH·ª®NG CH·ªà -->
        <section class="section">
          <div class="section-head">
            <h2 class="section-title">CH·ª®NG CH·ªà</h2>
            <div class="section-line"></div>
          </div>
          <div id="certList" class="plain-list"></div>
        </section>

        <!-- K·ª∏ NƒÇNG -->
        <section class="section">
          <div class="section-head">
            <h2 class="section-title">K·ª∏ NƒÇNG</h2>
            <div class="section-line"></div>
          </div>
          <div id="skillList" class="plain-list"></div>
        </section>
      </div>

      <!-- Nh√≥m n√∫t g√≥c ph·∫£i -->
      <div class="cv-actions no-print">
        <button
          class="icon-btn"
          type="button"
          title="In CV"
          aria-label="In CV"
          onclick="printPDF()"
        >
          üñ®Ô∏è
        </button>

        <button
          class="icon-btn"
          type="button"
          title="T·∫£i CV PDF"
          aria-label="T·∫£i CV PDF"
          onclick="downloadPDF()"
        >
          ‚¨áÔ∏è
        </button>
      </div>
    </main>

    <!-- html2pdf -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <!-- app.js n·∫øu b·∫°n ƒëang ƒë·ªï d·ªØ li·ªáu ƒë·ªông -->
    <script src="app.js"></script>
    <script>
      function printPDF() {
        // ƒë·∫£m b·∫£o font/·∫£nh k·ªãp render
        setTimeout(() => window.print(), 50);
      }
    </script>

    <script>
      function waitForLayout() {
        return new Promise((resolve) =>
          requestAnimationFrame(() => requestAnimationFrame(resolve)),
        );
      }

      function waitForImages(root) {
        const imgs = Array.from(root.querySelectorAll("img"));
        return Promise.all(
          imgs.map(
            (img) =>
              new Promise((resolve) => {
                if (img.complete) return resolve();
                img.onload = () => resolve();
                img.onerror = () => resolve();
              }),
          ),
        );
      }

      async function downloadPDF() {
        const btn = document.querySelector(".pdf-download-btn");
        const oldText = btn ? btn.textContent : "‚¨áÔ∏è";

        try {
          if (btn) {
            btn.disabled = true;
            btn.textContent = "‚è≥";
          }

          if (typeof html2pdf === "undefined") {
            alert("Kh√¥ng load ƒë∆∞·ª£c html2pdf. Ki·ªÉm tra m·∫°ng/CDN.");
            return;
          }

          // N·∫øu m·ªü b·∫±ng file:// th√¨ browser ch·∫∑n ·∫£nh/canvas -> PDF c√≥ th·ªÉ m·∫•t avatar
          // (L√™n git/host http(s) s·∫Ω OK)
          if (location.protocol === "file:") {
            alert(
              "B·∫°n ƒëang m·ªü b·∫±ng file:// n√™n tr√¨nh duy·ªát c√≥ th·ªÉ ch·∫∑n ·∫£nh khi xu·∫•t PDF. " +
                "H√£y d√πng Live Server ho·∫∑c ƒë∆∞a l√™n GitHub Pages ƒë·ªÉ xu·∫•t PDF ƒë·∫ßy ƒë·ªß.",
            );
            return;
          }

          await waitForLayout();
          if (document.fonts && document.fonts.ready)
            await document.fonts.ready;

          const cvEl = document.querySelector(".cv");
          if (!cvEl) {
            alert("Kh√¥ng t√¨m th·∫•y .cv ƒë·ªÉ xu·∫•t PDF");
            return;
          }

          // clone ƒë·ªÉ export
          const clone = cvEl.cloneNode(true);

          // ·∫©n ph·∫ßn kh√¥ng in
          clone
            .querySelectorAll(".no-print")
            .forEach((el) => (el.style.display = "none"));

          // reset nh·ªØng th·ª© hay l√†m html2canvas t√≠nh sai
          clone.style.margin = "0";
          clone.style.transform = "none";
          clone.style.boxShadow = "none";

          // container off-screen
          const wrap = document.createElement("div");
          wrap.style.position = "fixed";
          wrap.style.left = "-100000px";
          wrap.style.top = "0";
          wrap.style.background = "#fff";
          wrap.style.padding = "0";
          wrap.style.margin = "0";
          wrap.appendChild(clone);
          document.body.appendChild(wrap);

          await waitForImages(clone);
          await waitForLayout();

          const opt = {
            margin: 0,
            filename: "CV-Huynh-Thi-Kim-Han.pdf",
            image: { type: "jpeg", quality: 0.98 },
            html2canvas: {
              scale: 2,
              useCORS: true,
              allowTaint: false,
              backgroundColor: "#ffffff",
              scrollY: 0,
              windowWidth: clone.scrollWidth,
            },
            jsPDF: { unit: "mm", format: "a4", orientation: "portrait" },
          };

          await html2pdf().set(opt).from(clone).save();

          document.body.removeChild(wrap);
        } catch (e) {
          console.error(e);
          alert("Xu·∫•t PDF l·ªói. M·ªü Console (F12) xem chi ti·∫øt.");
        } finally {
          if (btn) {
            btn.disabled = false;
            btn.textContent = oldText || "‚¨áÔ∏è";
          }
        }
      }
    </script>
  </body>
</html>
